pipeline:
  ecr:
    image: plugins/ecr
    registry: 862793644923.dkr.ecr.ap-northeast-1.amazonaws.com
    repo: 862793644923.dkr.ecr.ap-northeast-1.amazonaws.com/test_k8sdocker
    region: ap-northeast-1
    tag: ${DRONE_TAG}
    file: Dockerfile 
    build_args: "GIT_TAG=${DRONE_TAG}"
    when:
      event: tag

  auth:
    image: drone-auth-ecr
    commands:
      - aws ecr get-login --region ap-northeast-1 | bash 
      - echo DRONE_${DRONE_TAG}
      - docker pull 862793644923.dkr.ecr.ap-northeast-1.amazonaws.com/test_k8sdocker:${DRONE_TAG}
    when:
      state: success

  test:
    image: 862793644923.dkr.ecr.ap-northeast-1.amazonaws.com/test_k8sdocker:${DRONE_TAG}
    commands:
      - curl http://127.0.0.1:80
    when:
      state: success
